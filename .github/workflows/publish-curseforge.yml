name: Publish to CurseForge

on: 
  release:
    types:  [published]

jobs:
  publish:
    runs-on:  ubuntu-latest
    
    steps:
      - name: Download release asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run:  |
          # Get the release assets
          ASSETS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }}/assets")
          
          # Find the decorations-plus.zip file (fixed jq syntax - no spaces)
          ASSET_URL=$(echo "$ASSETS" | jq -r '.[]|select(.name=="decorations-plus.zip")|.url')
          
          if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" == "null" ]; then
            echo "‚ùå Could not find decorations-plus.zip in release assets!"
            echo "Available assets:"
            echo "$ASSETS" | jq -r '.[].name'
            exit 1
          fi
          
          echo "üì• Downloading decorations-plus.zip from:  $ASSET_URL"
          curl -L -H "Authorization:  token $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            "$ASSET_URL" -o decorations-plus.zip
          
          # Verify download
          if [ -f "decorations-plus.zip" ]; then
            echo "‚úÖ Downloaded successfully!"
            ls -lh decorations-plus.zip
            echo ""
            echo "üìã Contents:"
            unzip -l decorations-plus.zip
          else
            echo "‚ùå Download failed!"
            exit 1
          fi

      - name: Extract versions and upload to CurseForge
        env:
          CURSEFORGE_TOKEN: ${{ secrets.CURSEFORGE_TOKEN }}
          PROJECT_ID: 1356841
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          IS_PRERELEASE: ${{ github.event.release.prerelease }}
        run: |
          # Extract Minecraft versions from release body
          # Format: <!-- minecraft-versions:  1.21, 1.21.2, 1.21.3 -->
          VERSIONS=$(echo "$RELEASE_BODY" | grep -oP '(? <=<!-- minecraft-versions: ).*(? = -->)' || echo "")
          
          if [ -z "$VERSIONS" ]; then
            echo "‚ùå No Minecraft versions specified in release body!"
            echo "Please add: <!-- minecraft-versions: 1.21, 1.21.2, 1.21.3 -->"
            exit 1
          fi
          
          echo "Found Minecraft versions: $VERSIONS"
          
          # Fetch all available game versions from CurseForge
          echo "Fetching CurseForge game versions..."
          GAME_VERSIONS=$(curl -s -H "X-Api-Token: ${CURSEFORGE_TOKEN}" \
            "https://minecraft.curseforge.com/api/game/versions")
          
          # Convert comma-separated versions to array and find their IDs
          VERSION_IDS="["
          FIRST=true
          
          IFS=',' read -ra VERSION_ARRAY <<< "$VERSIONS"
          for VERSION in "${VERSION_ARRAY[@]}"; do
            # Trim whitespace
            VERSION=$(echo "$VERSION" | xargs)
            
            # Find the ID for this version (fixed jq syntax)
            VERSION_ID=$(echo "$GAME_VERSIONS" | jq -r ".[]|select(.name==\"$VERSION\")|.id")
            
            if [ -z "$VERSION_ID" ] || [ "$VERSION_ID" == "null" ]; then
              echo "‚ö†Ô∏è Warning: Could not find CurseForge ID for Minecraft $VERSION"
              continue
            fi
            
            echo "‚úì Minecraft $VERSION -> ID:  $VERSION_ID"
            
            if [ "$FIRST" = true ]; then
              VERSION_IDS="${VERSION_IDS}${VERSION_ID}"
              FIRST=false
            else
              VERSION_IDS="${VERSION_IDS},${VERSION_ID}"
            fi
          done
          
          VERSION_IDS="${VERSION_IDS}]"
          
          if [ "$VERSION_IDS" == "[]" ]; then
            echo "‚ùå No valid Minecraft versions found!"
            exit 1
          fi
          
          echo "Game version IDs: $VERSION_IDS"
          
          # Prepare changelog (escape for JSON)
          CHANGELOG=$(echo "$RELEASE_BODY" | jq -Rs .)
          
          # Determine release type
          RELEASE_TYPE="release"
          if [[ "$RELEASE_TAG" == *"beta"* ]] || [[ "$IS_PRERELEASE" == "true" ]]; then
            RELEASE_TYPE="beta"
          elif [[ "$RELEASE_TAG" == *"alpha"* ]]; then
            RELEASE_TYPE="alpha"
          fi
          
          echo ""
          echo "üöÄ Uploading to CurseForge..."
          echo "   Display Name:  Decorations Plus $RELEASE_TAG"
          echo "   Release Type: $RELEASE_TYPE"
          echo "   Game Versions: $VERSION_IDS"
          echo ""
          
          # Upload the data pack to CurseForge
          RESPONSE=$(curl -X POST \
            "https://minecraft.curseforge.com/api/projects/${PROJECT_ID}/upload-file" \
            -H "X-Api-Token: ${CURSEFORGE_TOKEN}" \
            -F "metadata={\"changelog\": $CHANGELOG,\"changelogType\":\"markdown\",\"displayName\":\"Decorations Plus $RELEASE_TAG\",\"gameVersions\":${VERSION_IDS},\"releaseType\":\"${RELEASE_TYPE}\"};type=application/json" \
            -F "file=@decorations-plus.zip" \
            -w "\nHTTP_STATUS:%{http_code}")
          
          # Extract HTTP status code
          HTTP_STATUS=$(echo "$RESPONSE" | grep -oP 'HTTP_STATUS:\K\d+')
          BODY=$(echo "$RESPONSE" | sed 's/HTTP_STATUS:[0-9]*//g')
          
          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_STATUS"
          
          # Check if upload was successful (200-299 status codes)
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            FILE_ID=$(echo "$BODY" | jq -r '.id//empty')
            if [ -n "$FILE_ID" ]; then
              echo "‚úÖ Successfully uploaded to CurseForge!  File ID: $FILE_ID"
              echo "file_id=$FILE_ID" >> $GITHUB_ENV
            else
              echo "‚úÖ Upload completed with status $HTTP_STATUS"
            fi
          else
            echo "‚ùå Upload failed with status $HTTP_STATUS"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            exit 1
          fi

      - name:  Comment on Release
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fileId = process.env.file_id;
            let body = 'üéâ Successfully published to [CurseForge](https://www.curseforge.com/minecraft/data-packs/decorations-plus)!';
            
            if (fileId) {
              body += `\n\nüì¶ File ID: ${fileId}`;
            }
            
            await github.rest.repos.createReleaseComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: body
            });