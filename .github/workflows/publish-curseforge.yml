name: Publish to CurseForge

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Release Artifact
        uses: actions/download-artifact@v4
        with:
          name: decorations-plus
          path: .

      - name: Prepare Release Info
        id: info
        run: |
          echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.release.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "is_prerelease=${{ github.event.release.prerelease }}" >> $GITHUB_OUTPUT

      - name: Upload to CurseForge
        env:
          CURSEFORGE_TOKEN: ${{ secrets.CURSEFORGE_TOKEN }}
          PROJECT_ID: 1356841
          RELEASE_TAG: ${{ steps.info.outputs.tag }}
          IS_PRERELEASE: ${{ steps.info.outputs.is_prerelease }}
          RELEASE_BODY: ${{ steps.info.outputs.body }}
        run: |
          echo "üìÑ Release tag: $RELEASE_TAG"
          echo "üìò Pre-release: $IS_PRERELEASE"

          # Extract version list from HTML comment
          VERSIONS=$(echo "$RELEASE_BODY" | sed -n 's/.*<!-- minecraft-versions: \(.*\) -->.*/\1/p' | tr -d "\r")
          if [ -z "$VERSIONS" ]; then
            echo "‚ùå No minecraft versions found!"
            exit 1
          fi

          echo "Found Minecraft versions: $VERSIONS"

          # Fetch CurseForge version list
          GAME_VERSIONS=$(curl -s -H "X-Api-Token: ${CURSEFORGE_TOKEN}" \
            "https://minecraft.curseforge.com/api/game/versions")

          # Filter valid MC version IDs using Node
          VERSION_IDS=$(node <<EOF
          const all = JSON.parse(process.env.GAME_VERSIONS);
          const wanted = process.env.VERSIONS.split(",").map(v => v.trim());

          const matched = all.filter(v =>
            wanted.includes(v.name) &&
            v.gameVersionStatus === 1 &&
            v.versionType === "release" &&
            v.gameVersionTypeID === null
          );

          console.log(JSON.stringify(matched.map(v => v.id)));
          EOF
          )

          echo "üéØ Valid CurseForge IDs: $VERSION_IDS"

          if [ "$VERSION_IDS" = "[]" ]; then
            echo "‚ùå No valid CurseForge version IDs found!"
            exit 1
          fi

          # Determine release type
          RELEASE_TYPE="release"
          if [[ "$RELEASE_TAG" == *"beta"* ]] || [[ "$IS_PRERELEASE" == "true" ]]; then
            RELEASE_TYPE="beta"
          elif [[ "$RELEASE_TAG" == *"alpha"* ]]; then
            RELEASE_TYPE="alpha"
          fi

          echo "üöÄ Release type: $RELEASE_TYPE"

          # Build metadata JSON (safe, exact formatting)
          METADATA=$(node <<EOF
          console.log(JSON.stringify({
            changelog: process.env.RELEASE_BODY,
            changelogType: "markdown",
            displayName: "Decorations Plus " + process.env.RELEASE_TAG,
            gameVersions: JSON.parse(process.env.VERSION_IDS),
            releaseType: "${RELEASE_TYPE}"
          }));
          EOF
          )

          echo "üìù Final metadata:"
          echo "$METADATA"

          # Upload file
          echo "üì§ Uploading to CurseForge‚Ä¶"
          RESPONSE=$(curl -X POST \
            "https://minecraft.curseforge.com/api/projects/${PROJECT_ID}/upload-file" \
            -H "X-Api-Token: ${CURSEFORGE_TOKEN}" \
            -F "metadata=$METADATA;type=application/json" \
            -F "file=@decorations-plus.zip" \
            -w "\nHTTP_STATUS:%{http_code}")

          HTTP_STATUS=$(echo "$RESPONSE" | grep -oP 'HTTP_STATUS:\K\d+')
          BODY=$(echo "$RESPONSE" | sed 's/HTTP_STATUS:[0-9]*//g')

          echo "üì° Response: $BODY"
          echo "üìü HTTP Status: $HTTP_STATUS"

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            FILE_ID=$(node -e "console.log(JSON.parse(process.argv[1]).id || '')" "$BODY")
            echo "file_id=$FILE_ID" >> $GITHUB_ENV
            echo "‚úÖ Upload success ‚Äî File ID: $FILE_ID"
          else
            echo "‚ùå Upload failed"
            echo "$BODY"
            exit 1
          fi
